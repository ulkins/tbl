<!DOCTYPE html>
<html>
<head>
    <title>Main</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <link href="styles/main.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="Content/themes/base/jquery-ui.css" />
    <script src="http://public.tableausoftware.com/javascripts/api/tableau_v8.js"></script>
    <script src="scripts/jquery-2.0.3.min.js"></script>
    <script src="scripts/jquery-ui-1.10.3.min.js"></script>
    <script src="scripts/knockout-2.3.0.js"></script>
    <script src="scripts/highcharts.js"></script>
    <script src="scripts/sprintf.js"></script>
    
    <script type="text/javascript">
        var mapDashboard = null;
        var detailsDashboard = null;
        var workbook, activeSheet;
        function switchDashboard(select) {
            var selectedId = $(select).val();
            $("[id^='cbxLoan']").prop("checked", true);
            
            switch (selectedId) {
                case "Region1":
                    url = "http://public.tableausoftware.com/views/SampleDashboard-Region1/Dashboard4";
                    break;
                case "Region2":
                    url = "http://public.tableausoftware.com/views/SampleDashboard-Region2/Dashboard5";
                    break;
                case "Region3":
                    url = "";
                    break;
                case "Region4":
                    url = "";
                    break;
                case "Region5":
                    url = "";
                    break;
                case "Region6":
                    url = "";
                    break;
                case "RegionWorld":
                    url = "";
                    break;
            }
            if (url != "") {
                if (detailsDashboard != null) detailsDashboard.dispose();
                $("#detailsDashboard").html("");
                initializeDashboard("detailsDashboard", url, 869, 1004, true);

            } else {
                if (detailsDashboard != null) detailsDashboard.dispose();
                $("#detailsDashboard").html("[" + selectedId + " Placeholder]");
            }
        }

        function onMarksSelection(marksEvent) {
            return marksEvent.getMarksAsync().then(reportSelectedMarks);
        }

        function reportSelectedMarks(marks) {
            
            var html = [];
            var selectedRegion = "";
            for (var markIndex = 0; markIndex < marks.length; markIndex++) {
                var pairs = marks[markIndex].getPairs();
                
                for (var pairIndex = 0; pairIndex < pairs.length; pairIndex++) {
                    var pair = pairs[pairIndex];
                    if (pair.fieldName == "Region") {
                        selectedRegion = pair.formattedValue;
                    }
                    
                }
                
            }
            if (marks.length > 0) {
                var sel = $("#regionSelector");
                switch (selectedRegion) {
                case "East Asia and the Pacific":
                    sel.val("Region6");
                    break;
                case "Europe and Central Asia":
                    sel.val("Region1");
                    break;
                case "Latin America and the Caribbean":
                    sel.val("Region2");
                    break;
                case "Middle East and North Africa":
                    sel.val("Region3");
                    break;
                case "South Asia":
                    sel.val("Region4");
                    break;
                case "Sub-Saharan Africa":
                    sel.val("Region5");
                    break;
                }
                switchDashboard(sel);
            }

        }

        var currentFilters = ['All'];
        function loanSizeParameterChanged(cbx) {
            var cb = $(cbx);
            var val = cb.val();
            var checked = cb.prop("checked");
            
            switch (val) {
                case "All":
                    $("[id^='cbxLoan']").prop("checked", checked);
                    break;
                case "Sme":
                    $("#cbxLoanSmall, #cbxLoanMedium").prop("checked", checked);
                    break;
                case "Small":
                case "Medium":
                    if ($("#cbxLoanSmall").prop("checked") && $("#cbxLoanMedium").prop("checked")) {
                        $("#cbxLoanSme").prop("checked", true);
                    } else {
                        $("#cbxLoanSme").prop("checked", false);
                    }
                    break;
            }
            if ($("#cbxLoanSmall").prop("checked") && $("#cbxLoanMedium").prop("checked") && $("#cbxLoanRetail").prop("checked")
                && $("#cbxLoanCorporate").prop("checked") && $("#cbxLoanMicro").prop("checked")) {
                $("#cbxLoanAll").prop("checked", true);
            } else {
                $("#cbxLoanAll").prop("checked", false);
            }

            var filter = [];
            $("[id^='cbxLoan']:checked").each(function(index) {
                filter[index] = $(this).val();
            });
            var vizs = tableauSoftware.VizManager.getVizs();
            for (var i = 0; i < vizs.length; i++) {
                var viz = $(vizs[i].getParentElement());
                if (viz.attr('id') == "detailsDashboard") {
                    detailsDashboard = vizs[i];
                    break;
                }
            }
            var worksheets = detailsDashboard.getWorkbook().getActiveSheet().getWorksheets();
            for (var i = 0; i < worksheets.length; i++) { 
                var ws = worksheets[i];
                ws.applyFilterAsync("Loan Size", filter, tableauSoftware.FilterUpdateType.REPLACE);
                
            }
            var filterDescr = '';
            var hasSme = false;
            for (var i = 0; i < filter.length; i++) {
                var f = filter[i];
                if (f == "All") {
                    filterDescr = f;
                    break;
                } else {
                    if (f == "Sme") {
                        hasSme = true;
                        filterDescr += (filterDescr == '' ? '' : ', ') + "SME";
                    } else {
                        if (f == "Small" || f == "Medium") {
                            filterDescr += (hasSme ? '' : (filterDescr == '' ? '' : ', ') + f);
                        } else {
                            filterDescr += (filterDescr == '' ? '' : ', ') + f;
                        }
                    }
                }
            }

            $("#loanDescription").text(filterDescr);
        }

        
        function initializeDashboard(divId, url, height, width, isDetails) {
            var placeholderDiv = document.getElementById(divId);
            var options = {
                width: width!=undefined && width != null ? width : placeholderDiv.offsetWidth,
                height: height,
                hideTabs: true,
                hideToolbar: true
                
            };
            
            var viz = new tableauSoftware.Viz(placeholderDiv, url, options);
            if (isDetails) {
                detailsDashboard = viz;
            } else {
                mapDashboard = viz;
            }
            return viz;
        }

        function showLoanSizeSelector() {
            $("#loanSelector").dialog({modal: true});
            //$("#loanSelector").show();
            //$("#loanDescriptionWrapper").hide();
        }

        $(function () {
            var sel = $("#regionSelector");
            switchDashboard(sel[0]);
            initializeDashboard("mapDashboard", "http://public.tableausoftware.com/views/SampleDashboard2_2/Dashboard3", 600, null, false);
            mapDashboard.addEventListener(tableauSoftware.TableauEventName.MARKS_SELECTION, onMarksSelection);
            
        });

    </script>
</head>
<body>
    <div id="wrap">
        <div id="header">
            <script type="text/javascript">
                $("#header").load("header.html");
            </script>
        </div>
        <div id="main">
            <h2 style="font-size: 1.5em"> IFC Financing to Micro, Small and Medium Enterprises - Outreach Data</h2>
            <div>


            </div>
            <div class="clear"></div>
            <div id="data">
                <div class="section clearfix">
                    <div id="bottom-left">
                        Lack of access to financial services is a key barrier to the growth of micro, small, medium enterprises (MSMEs). IFC is working to develop solutions to close the MSME financing gap. By partnering with many types of financial intermediaries, including microfinance institutions (MFIs), commercial banks, leasing companies, and private equity funds, IFC reaches many more small and medium enterprises (SMEs) than it could directly.
                    </div>
                    <div id="bottom-middle">
                        <div>Collaborating with <strong>314</strong> financial institutions (FIs) across <strong>90</strong> countries globally, including <strong>129</strong> FIs accross <strong>39</strong> International Development Assosiation (IDA) countries </div>

                    </div>
                    <div id="bottom-right">
                        <div style="float: right">
                            <h2 class="logo_title" style="font-size: 1.2em">Connect with us</h2>
                            <div style="width: 50px; margin: 0 auto;">
                                <div id="twitter_logo">
                                    <a href="https://twitter.com/SMEFinanceForum" title="SME Finance Forum Twitter" target="_blank">
                                        <div style="width: 100%; height: 100%"></div>
                                    </a>
                                </div>
                                <div id="linkedin_logo">
                                    <a href="http://www.linkedin.com/groups/SME-Finance-Forum-managed-IFC-4416977" title="SME Finance Forum LinkedIn" target="_blank">
                                        <div style="width: 100%; height: 100%"></div>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="clear"></div>

            <div id="mapDashboard" style="width: 100%">
                
            </div>

            <div class="left" style="margin-right: 30px">
                <div>
                    Select Region: <select id="regionSelector" onchange="switchDashboard(this)">
                        <option value="Region1">Region 1</option>
                        <option value="Region2">Region 2</option>
                        <option value="Region3">Region 3</option>
                        <option value="Region4">Region 4</option>
                        <option value="Region5">Region 5</option>
                        <option value="Region6">Region 6</option>
                        <option value="RegionWorld">World</option>
                    </select>
                </div>
            </div>
            <div class="left">
                <div id="loanDescriptionWrapper" style="cursor:pointer; height: 24px; padding-top: 5px" onclick="showLoanSizeSelector()">Loan size: <span id="loanDescription">All</span></div>
                <div id="loanSelector" title="Select loan size" style="display: none">
                    <div>All <input type="checkbox" id="cbxLoanAll" checked="checked" onchange="loanSizeParameterChanged(this)" value="All" /></div>
                    <div>Retail <input type="checkbox" id="cbxLoanRetail" checked="checked" onchange="loanSizeParameterChanged(this)" value="Retail" /></div>
                    <div>Micro <input type="checkbox" id="cbxLoanMicro" checked="checked" onchange="loanSizeParameterChanged(this)" value="Micro" /></div>
                    <div>SME <input type="checkbox" id="cbxLoanSme" checked="checked" onchange="loanSizeParameterChanged(this)" value="Sme" /></div>
                    <div style="padding-left: 20px">Small <input type="checkbox" id="cbxLoanSmall" checked="checked" onchange="loanSizeParameterChanged(this)" value="Small" /></div>
                    <div style="padding-left: 20px">Medium <input type="checkbox" id="cbxLoanMedium" checked="checked" onchange="loanSizeParameterChanged(this)" value="Medium" /></div>
                    <div>Corporate <input type="checkbox" id="cbxLoanCorporate" checked="checked" onchange="loanSizeParameterChanged(this)" value="Corporate" /></div>
                </div>
            </div>
            <div class="clear"></div>
            <div id="detailsDashboard" style="width: 100%">
            </div>
                

            </div>
    </div>

    <div id="footer">
        <script type="text/javascript">
            $("#footer").load("footer.html");
        </script>
    </div>
    
</body>
</html>
